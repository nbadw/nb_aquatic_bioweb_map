if(typeof(window.console)==="undefined"){window.console={log:function(){}}}String.prototype.capitalize=function(){if(this.length===0){return""}else{return this.substr(0,1).toUpperCase()+this.substr(1)}};String.prototype.titleize=function(){if(this.length===0){return""}else{var c=this.split(" ");for(var b=0,a=c.length;b<a;b++){c[b]=c[b].capitalize()}return c.join(" ")}};Number.prototype.formatHuman=function(){var d=""+this;var e=d.split(".");var c=e[0];var a=e[1]||"";var b=/(\d+)(\d{3})/;while(b.test(c)){c=c.replace(b,"$1,$2")}return a.length===0?c:c+"."+a};Ext.ns("Atlas.esri");Atlas.esri.Map=function(b,a){a=a||{};this.proxy=new esri.Map(b,a);this.proxy.proxyOwner=this;Ext.applyIf(this,this.proxy);this.addEvents("load","layeradd","beforeupdate","update","click","extentchange");this.registerProxyEvents();this.registerLayerUpdateTriggers();Ext.each(a.layers,function(c){this.availableLayers+=1;this.addLayer(c)},this)};Ext.extend(Atlas.esri.Map,Ext.util.Observable,{layers:[],availableLayers:0,loadCount:0,visibleCount:0,updating:false,addLayer:function(b,a){b=new Atlas.esri.Layer(b);b.on("update",this.onLayerUpdated,this);b.on("load",function(c){console.log("loaded "+c.url);this.layers.push(c);this.proxy.addLayer(c.proxy)},this);b.on("error",function(c){this.availableLayers-=1},this)},registerProxyEvents:function(){dojo.connect(this.proxy,"onLoad",this,function(a){this.fireEvent("load",a)});dojo.connect(this.proxy,"onLayerAdd",this,function(a){this.fireEvent("layeradd",a.proxyOwner)});dojo.connect(this.proxy,"onClick",this,function(a){this.fireEvent("click",a)});dojo.connect(this.proxy,"onExtentChange",this,function(a,d,c,b){this.fireEvent("extentchange",a,d,c,b)})},registerLayerUpdateTriggers:function(){Ext.each(["onZoomStart","onPanStart"],function(a){dojo.connect(this.proxy,a,this,function(){this.loadCount=0;this.visibleCount=this.countVisibleLayers();this.updating=true;this.fireEvent("beforeupdate")})},this)},onLayerUpdated:function(){this.loadCount++;if(this.loadCount===this.visibleCount){this.updating=false;this.fireEvent("update")}},countVisibleLayers:function(){var a=0;Ext.each(this.layers,function(b){if(b.proxy.visible){a+=1}});return a}});Ext.ns("Atlas.esri");Atlas.esri.Layer=function(a){this.proxy=this.createLayer(a);this.proxy.proxyOwner=this;Ext.applyIf(this,this.proxy);this.title=a.title;if(a.identifiable){this.identifiable=a.identifiable}this.addEvents("error","load","opacitychange","update","visibilitychange","legend");dojo.connect(this.proxy,"onError",this,function(b){this.fireEvent("error",b)});dojo.connect(this.proxy,"onLoad",this,function(b){this.fireEvent("load",b.proxyOwner)});dojo.connect(this.proxy,"onOpacityChange",this,function(b){this.fireEvent("opacitychange",b)});dojo.connect(this.proxy,"onUpdate",this,function(){this.fireEvent("update")});dojo.connect(this.proxy,"onVisibilityChange",this,function(b){this.fireEvent("visibilitychange",b)});this.on("error",function(b){var c="error while loading "+this.url+"\n";c+="  code - "+b.code+"\n";c+="  details - "+b.message;Ext.each(b.details,function(d){c+="\n  "+d});console.log(c)},this)};Ext.extend(Atlas.esri.Layer,Ext.util.Observable,{legendLoaded:false,identifiable:false,name:function(){if(!this.title){var a=this.proxy.url.split("/");var b=a[a.length-2].replace("_"," ","g").titleize();this.title=b}return this.title},canIdentify:function(){return(this.identifiable&&this.proxy.visible)},createLayer:function(b){if(b instanceof esri.layers.Layer){return b}else{if(typeof b==="string"){return new esri.layers.ArcGISDynamicMapServiceLayer(b)}else{var a={visible:b.visible,opacity:b.opacity};if(b.cached||b.tiled){return new esri.layers.ArcGISTiledMapServiceLayer(b.url,a)}else{return new esri.layers.ArcGISDynamicMapServiceLayer(b.url,a)}}}},loadLegend:function(){this.requestLegend()},requestLegend:function(){Ext.Ajax.request({url:Services.path+"/legends",params:{url:this.url,image_return_url:(Ext.isIE&&!Ext.isIE8)},method:"GET",success:function(a,b){this.legend=Ext.decode(a.responseText);this.legendLoaded=true;this.fireEvent("legend",this,this.legend)},failure:function(){console.log("load legend failed");console.log(arguments);this.legendLoaded=true;this.fireEvent("legend",this,null)},scope:this})}});Ext.ns("Atlas");Atlas.IdentifyPanel=Ext.extend(Ext.Panel,{initComponent:function(){Ext.apply(this,{layout:"card",activeItem:0,flex:1,border:false,items:[this.createMessagePanel("no-identifiable-layers-panel","No layers to identify.  Only certain layers can be queried and they must be visible."),this.createResultsPanel()]});this.addEvents("geometryselected");Atlas.IdentifyPanel.superclass.initComponent.apply(this,arguments)},activateNoIdentifiableLayersPanel:function(){this.getLayout().setActiveItem(0)},activateResultsPanel:function(){this.getLayout().setActiveItem(1)},createMessagePanel:function(c,b){var a=new Ext.Panel({bodyCssClass:c,layout:"vbox",border:false,bodyStyle:"padding: 10px;",layoutConfig:{pack:"center",align:"center"},items:{id:c+"-msg",html:b,border:false}});return a},createResultsPanel:function(){var c=new Ext.grid.PropertyGrid({autoScroll:true,border:false,stripeRows:true,source:{},listeners:{beforeedit:function(){return false}}});var b=new Ext.Panel({layout:"card",region:"center",border:false,activeItem:0,items:[this.createMessagePanel("no-result-selected-panel","Expand a layer to load its results; select a result to view its attributes."),c]});this.resultsTree=new Atlas.IdentifyResultsTreePanel({region:"west",width:200,minWidth:150,split:true,listeners:{click:function(f,e){var d=f.attributes.result;if(d){c.setSource(d.feature.attributes);c.getView().refresh(true);b.getLayout().setActiveItem(1)}else{b.getLayout().setActiveItem(0)}if(d&&d.feature.geometry){this.fireEvent("geometryselected",d,d.feature.geometry)}},scope:this}});var a=new Ext.Panel({layout:"border",items:[this.resultsTree,b]});return a},doIdentify:function(a,c){this.resultsTree.clearResults();var b=a.proxyOwner;Ext.each(b.layers,function(e){if(e.canIdentify()){var d=new esri.tasks.IdentifyTask(e.url);var f=new esri.tasks.IdentifyParameters();var g=e.proxy.layerInfos;f.geometry=c;f.mapExtent=a.extent;f.tolerance=5;f.returnGeometry=false;f.layerOption=esri.tasks.IdentifyParameters.LAYER_OPTION_VISIBLE;f.height=a.height;f.width=a.width;f.dpi=96;this.resultsTree.addIdentifyTask(e,d,f)}},this);if(this.resultsTree.root.childNodes.length===0){this.activateNoIdentifiableLayersPanel()}else{this.activateResultsPanel()}}});Atlas.IdentifyResultsTreePanel=Ext.extend(Ext.tree.TreePanel,{autoScroll:true,animate:true,border:false,rootVisible:false,root:{text:"Results"},clearResults:function(){Ext.each(this.root.childNodes,function(a){this.root.removeChild(a)},this)},addIdentifyTask:function(b,a,d){var c=new Atlas.IdentifyTaskNode(b,a,d);this.root.appendChild(c)}});Atlas.IdentifyTaskNode=function(b,a,c){this.loaded=false;this.loading=false;this.layer=b;this.task=a;this.params=c;Atlas.IdentifyTaskNode.superclass.constructor.call(this,{text:b.title});this.addEvents("beforeload","load")};Ext.extend(Atlas.IdentifyTaskNode,Ext.tree.TreeNode,{expand:function(a,d,g,b){if(this.loading){var e;var c=function(){if(!this.loading){clearInterval(e);this.expand(a,d,g,b)}}.createDelegate(this);e=setInterval(c,200);return}if(!this.loaded){if(this.fireEvent("beforeload",this)===false){return}this.loading=true;this.ui.beforeLoad(this);this.startIdentifyTask(a,d,g,b);return}Atlas.IdentifyTaskNode.superclass.expand.call(this,a,d,g,b)},isLoading:function(){return this.loading},loadComplete:function(a,c,d,b){this.loading=false;this.loaded=true;this.ui.afterLoad(this);this.fireEvent("load",this);this.expand(a,c,d,b)},isLoaded:function(){return this.loaded},hasChildNodes:function(){if(!this.isLeaf()&&!this.loaded){return true}else{return Atlas.IdentifyTaskNode.superclass.hasChildNodes.call(this)}},startIdentifyTask:function(b,f,g,e){var d=this;var a=function(h){d.identifyTaskComplete(h);d.loadComplete(b,f,g,e)};var c=function(){d.identifyTaskFailed();d.loadComplete(b,f,g,e)};this.task.execute(this.params,a,c)},identifyTaskFailed:function(){this.showNoResults()},identifyTaskComplete:function(a){if(a.length>0){Ext.each(a,function(b){this.addResult(b)},this)}else{this.showNoResults()}},showNoResults:function(){var a=new Ext.tree.TreeNode({text:"No results found"});this.appendChild(a)},addResult:function(a){var c=this.findOrCreateLayerNode(a);var b=new Ext.tree.TreeNode({text:a.value,result:a});c.appendChild(b)},findOrCreateLayerNode:function(a){var b=this.findChild("layerId",a.layerId);if(!b){b=new Ext.tree.TreeNode({layerId:a.layerId,layerName:a.layerName,count:0,expanded:true});this.appendChild(b)}b.attributes.count=b.attributes.count+1;b.setText(b.attributes.layerName+" ("+b.attributes.count+")");return b}});Ext.ns("Atlas");Atlas.MapContents=Ext.extend(Ext.tree.TreePanel,{lines:false,cls:"x-map-contents",title:"Map Contents",rootVisible:false,autoScroll:true,minWidth:150,ready:false,legendsLoaded:0,iconCls:"map-contents",initComponent:function(){this.root=new Ext.tree.TreeNode({text:"Map Contents"});this.map.on("layeradd",function(b){this.addLayer(b)},this);this.addEvents("ready");Atlas.MapContents.superclass.initComponent.call(this);var a=new Atlas.MapContentsTreeSorter(this);this.on("checkchange",function(c,b){this.toggleLayerVisible(c,b)},this)},addLayer:function(a){if(a.proxy.loaded){this.loadLegend(a)}else{a.on("load",this.loadLegend,this)}},loadLegend:function(a){if(a.legendLoaded){this.layerReady(a,a.legend)}else{a.on("legend",this.layerReady,this);a.loadLegend()}},layerReady:function(a,b){this.buildLayerNodes(a,b);this.legendsLoaded++;if(this.legendsLoaded===this.map.availableLayers){this.fireEvent("ready")}},buildLayerNodes:function(a,b){var c=a.proxy;this.buildLayerNode(c);Ext.each(c.layerInfos,function(d){this.buildLayerInfoNode(c,d)},this);Ext.each(b,function(d){this.buildLegendInfoNode(c,d)},this)},buildLayerNode:function(b){var a=b.proxyOwner.name();this.root.appendChild(new Ext.tree.TreeNode({layerId:b.id,text:a,iconCls:"layer",layer:b,checked:b.visible,uiProvider:Atlas.LayerNodeUI,type:"LayerNode"}))},buildLayerInfoNode:function(a,c){var b=c.parentLayerId!==-1?this.findLayerInfoNode(a.id,c.parentLayerId):this.root.findChild("layerId",a.id);b.appendChild(new Ext.tree.TreeNode({text:c.name,layer:a,layerId:a.id,layerInfo:c,layerInfoId:c.id,uiProvider:Atlas.MapContentsNodeUI,type:"LayerInfoNode"}))},buildLegendInfoNode:function(c,b){var a=this.findLayerInfoNode(c.id,b.layer_id);var d=b.legend_groups[0];if(d.legend_classes.length===1){a.attributes.symbolImage=d.legend_classes[0].symbol_image}else{Ext.each(d.legend_classes,function(e){this.buildLegendClassNode(a,e)},this)}},addLegendToLayerInfo:function(d,c){var a=Ext.apply(d.attributes,{icon:c.image_url});var b=new Ext.tree.TreeNode(a);d.parentNode.replaceChild(b,d)},buildLegendClassNode:function(b,a){if(a.label===null){b.attributes.gradientLegendInfoNode=true}b.appendChild(new Ext.tree.TreeNode({text:a.label,qtip:a.description,symbolImage:a.symbol_image,legendClass:a,uiProvider:Atlas.MapContentsNodeUI,type:"LegendClassNode"}))},findLayerInfoNode:function(b,d){var a=null;var c=this.root.findChild("layerId",b);if(c){c.cascade(function(e){if(e.attributes.layerInfoId===d){a=e;return false}else{return true}})}return a},toggleLayerVisible:function(b,c){var a=b.attributes.layer;if(c){a.show();b.getUI().removeClass("layer-hidden")}else{a.hide();b.getUI().addClass("layer-hidden")}}});Atlas.LayerNodeUI=Ext.extend(Ext.tree.TreeNodeUI,{tooltipRegistered:false,render:function(a){Atlas.LayerNodeUI.superclass.render.apply(this,arguments);if(!this.tooltipRegistered){Atlas.MapContentsUtil.registerDescriptionTooltip(this.textNode,this.node.attributes.layer.url);this.tooltipRegistered=true}},onDblClick:function(a){a.preventDefault();if(this.disabled){return}if(!this.animating&&this.node.isExpandable()){this.node.toggle()}this.fireEvent("dblclick",this.node,a)}});Atlas.MapContentsNodeUI=Ext.extend(Ext.tree.TreeNodeUI,{focus:Ext.emptyFn,tooltipRegistered:false,render:function(a){Atlas.MapContentsNodeUI.superclass.render.apply(this,arguments);if(!this.tooltipRegistered&&this.node.attributes.layerInfo){var b=this.node.attributes.layer.url+"/"+this.node.attributes.layerInfo.id;Atlas.MapContentsUtil.registerDescriptionTooltip(this.textNode,b);this.tooltipRegistered=true}},renderElements:function(f,d,i,c){if(f.childNodes.length>0){d.iconCls="legend-group"}Atlas.MapContentsNodeUI.superclass.renderElements.apply(this,arguments);if(f.parentNode&&f.parentNode.attributes.gradientLegendInfoNode){f.getUI().addClass("gradient-legend-node")}if(d.symbolImage){var g=d.symbolImage;var a=Ext.fly(this.getIconEl());var b=16;var e=16;if(g.image_height!==g.image_width){b=(g.image_width*e)/g.image_height}a.applyStyles({backgroundImage:"none",height:e+"px",width:b+"px"});if(d.symbolImage.image_url){a.dom.src=d.symbolImage.image_url}else{a.dom.src="data:image/png;base64,"+d.symbolImage.image_data}}}});Atlas.MapContentsTreeSorter=Ext.extend(Ext.tree.TreeSorter,{customSortFn:function(b,a){if(b.childNodes.length>0||a.childNodes.length>0){if(b.childNodes.length>0&&a.childNodes.length>0){return(b.text.toUpperCase()>a.text.toUpperCase()?1:-1)}else{return(b.childNodes.length>0?-1:1)}}else{return(b.text.toUpperCase()>a.text.toUpperCase()?1:-1)}},doSort:function(a){if(!a.attributes.gradientLegendInfoNode){a.sort(this.customSortFn)}}});Atlas.MapContentsUtil={renderer:new (Ext.extend(Ext.Updater.BasicRenderer,{render:function(c,a,b,e){var d=Ext.decode(a.responseText);c.update(d.description||"No Description",b.loadScripts,e)}}))(),registerDescriptionTooltip:function(c,b){var a=new Ext.ToolTip({target:Ext.id(c),trackMouse:true,width:370,renderer:this.renderer,autoLoad:{method:"GET",url:Services.path+"/info",params:{url:b}}})}};Ext.ns("Atlas");Atlas.FindPanel=Ext.extend(Ext.Panel,{cls:"x-find-panel",initComponent:function(){this.layout={type:"vbox",align:"stretch",padding:5};var b=new Ext.data.GroupingStore({proxy:new Ext.data.HttpProxy({method:"GET",url:Services.path+"/places"}),reader:new Atlas.PlaceReader(),autoDestroy:true,sortInfo:{field:"geoname",direction:"ASC"},groupField:"generic_term"});var c=new Atlas.PlaceNameSearchField({style:"margin-bottom: 5px"});var a=new Ext.grid.GridPanel({flex:1,store:b,columns:[{id:"geoname",header:"Name",width:160,sortable:true,dataIndex:"geoname"},{header:"Province",width:75,dataIndex:"region_name"},{header:"Type",width:75,dataIndex:"generic_term"}],view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "Items" : "Item"]})'}),stripeRows:true,autoExpandColumn:"geoname",listeners:{cellclick:function(h,j,g,i){var f=h.getStore().getAt(j);var d=parseFloat(f.data.londec);var k=parseFloat(f.data.latdec);this.fireEvent("placeclick",f.data,d,k)},celldblclick:function(h,j,g,i){var f=h.getStore().getAt(j);var d=parseFloat(f.data.londec);var k=parseFloat(f.data.latdec);this.fireEvent("placedblclick",f.data,d,k)},scope:this}});a.on("render",function(){a.tip=new Ext.ToolTip({view:a.getView(),target:a.getView().mainBody,delegate:".x-grid3-row",trackMouse:true,renderTo:document.body,listeners:{beforeshow:function(g){var f=a.getView().findRowIndex(g.triggerElement);var d=a.getStore().getAt(f);var e=d.get("geoname");g.body.dom.innerHTML="Click to place a marker for "+e+" on the map, double-click to zoom to its location"}}})});this.resultsPanel=new Ext.Panel({layout:"card",activeItem:0,flex:1,items:[a,new Ext.Panel({bodyCssClass:"no-placename-results-panel",layout:"vbox",layoutConfig:{pack:"center",align:"center"},items:{id:"no-placename-results",html:"No results found for search query.",border:false}})]});this.items=[c,this.resultsPanel];c.on("triggered",function(d){b.load({params:{geoname:d}})});b.on("beforeload",function(d,e){if(!this.loadingMask){this.loadingMask=new Ext.LoadMask(this.resultsPanel.body,{msg:"Searching..."})}this.loadingMask.show()},this);b.on("load",function(e,d,f){this.resultsPanel.getLayout().setActiveItem(0);this.loadingMask.hide()},this);b.on("exception",function(){this.resultsPanel.getLayout().setActiveItem(1);this.loadingMask.hide()},this);Atlas.FindPanel.superclass.initComponent.call(this)}});Atlas.PlaceNameSearchField=Ext.extend(Ext.form.TriggerField,{triggerClass:"x-form-search-trigger",emptyText:"Enter a place name...",allowBlank:false,minLength:3,initComponent:function(){this.addEvents("triggered");Atlas.PlaceNameSearchField.superclass.initComponent.call(this);this.on("specialkey",function(a,b){if(b.getKey()===b.ENTER){this.onTriggerClick()}},this)},onTriggerClick:function(){if(this.validate()){this.fireEvent("triggered",this.getValue())}}});Atlas.PlaceReader=function(){var a={root:"PlaceName",idProperty:"cgndb_key",successProperty:"success",totalProperty:"total",fields:["generic_term","latitude","longitude","generic_code","location","region_name","relevance_at_scale","status_term","latdec","londec","datum","feature_id","coord_acc_m","geoname","concise_term","rs_value","concise_code","nts_map","cgndb_key"]};Atlas.PlaceReader.superclass.constructor.call(this,a,a.fields)};Ext.extend(Atlas.PlaceReader,Ext.data.JsonReader,{read:function(a){var c=a.responseText;var d=Ext.decode(c);if(!d){throw {message:"JsonReader.read: Json object not found"}}var b=d.SearchResults;return this.readRecords(d.SearchResults)}});Ext.ns("Atlas");Atlas.MapPanel=Ext.extend(Ext.Panel,{cls:"x-mappanel",initComponent:function(){this.tbar=[{id:"zoom-in",icon:"./images/zoom-in2.png",enableToggle:true,scale:"medium",toggleGroup:"map-tools",tooltip:"Click Zoom In tool, then draw box around area of interest. Note: click the Zoom In tool again to disable this feature and return to the cursor to Pan mode.",toggleHandler:function(a,b){if(b){this.enableDragZoom()}else{this.disableDragZoom()}},scope:this},{icon:"./images/full-extent2.png",scale:"medium",tooltip:"Click this tool to zoom to the full extent of the Province.",handler:function(){this.zoomToFullExtent()},scope:this},{id:"identify",icon:"./images/query.png",enableToggle:true,scale:"medium",toggleGroup:"map-tools",tooltip:"Click on the identify tool, and then click on a feature on the map to retrieve details on the feature. The results box will list the visible layers. Click on the layer for the results.",toggleHandler:function(a,b){if(b){this.enableIdentifyTool()}else{this.disableIdentifyTool()}},scope:this},{icon:"./images/search.png",tooltip:"Click on the Find tool, enter a place name or water body name, and press Enter (or click on the Search symbol). The Canadian Geographical Names Database at NR Canada will be searched and the results returned by geographical type (e.g. river, lake, city, parish, etc.).",scale:"medium",handler:this.showFindWindow,scope:this},{id:"measure",icon:"./images/ruler.png",tooltip:"Click on the Measure tool and then click on map to begin measuring distances. Click on map to create a vertex or change direction; double click to finish. The measured distance is displayed at the top of the map (units = meters).",enableToggle:true,scale:"medium",toggleGroup:"map-tools",toggleHandler:function(a,b){if(b){this.enableMeasurement()}else{this.disableMeasurement()}},scope:this}];this.bbar=[{id:"mapInfo",icon:"./images/world.png",handleMouseEvents:false,listeners:{mouseout:function(){},mouseover:function(){},scope:this}},{id:"map-status",xtype:"tbtext",text:"Loading..."},"->","-",{id:"coordinates",xtype:"tbtext",text:"X: - Y: -"},"-",{id:"scaleBar",xtype:"tbtext",text:""}];Atlas.MapPanel.superclass.initComponent.call(this)},afterRender:function(){Atlas.MapPanel.superclass.afterRender.call(this);this.zoomIn=Ext.getCmp("zoom-in");this.measure=Ext.getCmp("measure");this.identify=Ext.getCmp("identify");this.coordinates=Ext.getCmp("coordinates");this.scaleBar=Ext.getCmp("scaleBar");this.mapStatus=Ext.getCmp("map-status");this.measurementInfo=Ext.get("measurement-length-info");this.mapInfo=Ext.get("map-info")},initMapFunctionality:function(a){this.map=a;this.map.reposition();this.map.resize();this.map.disableRubberBandZoom();this.map.disableShiftDoubleClickZoom();this.on("resize",function(){if(this.map){this.map.reposition();this.map.resize()}},this);this.draw=new esri.toolbars.Draw(this.map);dojo.connect(this.draw,"onDrawEnd",this,this.handleDraw);this.navigation=new esri.toolbars.Navigation(this.map);dojo.connect(this.navigation,"onExtentHistoryChange",this,this.handleExtentHistoryChange);dojo.connect(this.map,"onExtentChange",this,function(b,e,d,c){if(d||this.scaleBar.getEl().dom.innerHTML===""){this.scaleBar.getEl().dom.innerHTML="Scale: "+Math.round(c.scale).formatHuman()}});dojo.connect(this.map,"onMouseMove",this,function(b){this.coordinates.getEl().dom.innerHTML="X: "+b.mapPoint.x.toPrecision(7)+" Y: "+b.mapPoint.y.toPrecision(7)});dojo.connect(this.map,"onMouseOut",this,function(){this.coordinates.getEl().dom.innerHTML="X: - Y: -"});this.attachUpdateMonitor()},attachUpdateMonitor:function(){var d=this.map.proxyOwner;var a=this.mapStatus.getEl();var f=new Ext.util.TaskRunner();var b={run:function(){var g=/\.{3}$/;var h=a.dom.innerHTML;if(g.test(h)){h=h.replace(g,"")}else{h+="."}a.update(h)},interval:100};var e=function(){a.show();f.start(b)};var c=function(){a.hide();f.stop(b)};if(d.updating){e.call()}else{c.call()}d.on("beforeupdate",e);d.on("update",c)},showFindWindow:function(){if(!this.findWindow){this.findWindow=this.createFindWindow()}this.findWindow.show(this)},createFindWindow:function(){return new Ext.Window({layout:"fit",width:500,height:500,closeAction:"hide",autoScroll:true,title:"Find a Place",items:new Atlas.FindPanel({border:false,listeners:{placeclick:this.onPlaceClick,placedblclick:this.onPlaceDblClick,scope:this}}),buttons:[{text:"Close",handler:function(){this.findWindow.hide();this.map.graphics.clear()},scope:this}]})},onPlaceClick:function(b,a,c){this.highlightPlace(b,a,c)},onPlaceDblClick:function(c,b,e){var a=new esri.geometry.Point(b,e,this.map.spatialReference);var d=new esri.geometry.Extent(b-0.1,e-0.1,b+0.1,e+0.1,this.map.spatialReference);this.map.setExtent(d,true);this.map.centerAt(a);this.highlightPlace(c,b,e)},highlightPlace:function(e,h,g){this.map.graphics.clear();var b=esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE;var i=7;var d=new dojo.Color([255,0,0,0.6]);var a=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,0,0,0.8]),1);var c=new esri.symbol.SimpleMarkerSymbol(b,i,a,d);var f=new esri.geometry.Point(h,g,this.map.spatialReference);this.map.graphics.add(new esri.Graphic(f,c))},enableDragZoom:function(){this.draw.activate(esri.toolbars.Draw.EXTENT)},disableDragZoom:function(){this.draw.deactivate()},calculateMeasurementLength:function(){if(!this.draw._tGraphic||!this.draw._graphic){return -1}var b=0;var a=this.draw._tGraphic.geometry.paths[0];b+=this.calculateDistance(a[0],a[1]);Ext.each(this.draw._graphic.geometry.paths[0],function(c,d,e){var f=this.cachedMeasurements[d];if(isNaN(f)){f=this.calculateDistance(e[d-1],c);this.cachedMeasurements[d]=f}b+=f},this);return b},calculateDistance:function(b,a){if(!this.sourceProjection){this.sourceProjection=new Proj4js.Proj("EPSG:"+this.map.spatialReference.wkid)}if(!this.targetProjection||!this.targetSRS){this.targetProjection=new Proj4js.Proj("EPSG:2953");this.targetSRS=new esri.SpatialReference({wkid:2953})}b=new Proj4js.Point(b[0],b[1]);a=new Proj4js.Point(a[0],a[1]);Proj4js.transform(this.sourceProjection,this.targetProjection,b);Proj4js.transform(this.sourceProjection,this.targetProjection,a);return esri.geometry.getLength(new esri.geometry.Point(b.x,b.y,this.targetSRS),new esri.geometry.Point(a.x,a.y,this.targetSRS))},clearMeasurement:function(){this.cachedMeasurements=[0]},updateMeasurement:function(){var a=this.calculateMeasurementLength();if(a!==-1){var b=parseFloat(a.toPrecision(7)).formatHuman();this.measurementInfo.update("Measurement: "+b+" m")}},enableMeasurement:function(){this.draw.activate(esri.toolbars.Draw.POLYLINE);this.measurementInfo.show();this.measurementInfo.update("Click on the map to begin measuring from that point");var a=dojo.connect(this.map,"onClick",this,function(){dojo.disconnect(a);this.clearMeasurement();this.updateMeasurement();this.draw.movementListener=dojo.connect(this.map,"onMouseMove",this,function(){this.updateMeasurement()})})},disableMeasurement:function(){if(this.draw.movementListener){dojo.disconnect(this.draw.movementListener)}this.draw.deactivate();this.map.graphics.clear();this.measurementInfo.hide()},handleDraw:function(c){if(this.zoomIn.pressed){this.map.setExtent(c,true)}if(this.measure.pressed){var b=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DASH,new dojo.Color([255,0,0]),1);var d=new esri.Graphic(c,b);this.map.graphics.add(d);if(this.draw.movementListener){dojo.disconnect(this.draw.movementListener)}var a=dojo.connect(this.map,"onClick",this,function(){dojo.disconnect(a);this.disableMeasurement();if(this.measure.pressed){this.enableMeasurement()}})}},zoomToFullExtent:function(){var a=Application.fullExtent;if(!a){this.navigation.zoomToFullExtent()}else{this.map.setExtent(a)}},handleExtentHistoryChange:function(){},enableIdentifyTool:function(){var a=this.map.proxyOwner;a.on("click",this.doIdentify,this,{single:true})},disableIdentifyTool:function(){this.identifyWindow.close();this.map.graphics.clear();this.map.proxyOwner.un("click",this.identifyWindowCloseHandler,this);if(this.identify.pressed){this.enableIdentifyTool()}},doIdentify:function(a){var b=new Atlas.IdentifyPanel();b.on("geometryselected",function(d,e){this.map.graphics.clear();var f=new esri.Graphic(e,new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,0,0]),1),new dojo.Color([255,255,0,0.5])));this.map.graphics.add(f)},this);this.identifyWindow=new Ext.Window({layout:"fit",title:"Identify",border:false,bodyStyle:"padding: 0",width:500,height:300,plain:true,items:[b],buttons:[{text:"Close",handler:function(){this.identifyWindow.close()},scope:this}]});var c=this.map;this.identifyWindow.on("show",function(){b.doIdentify(c,a.mapPoint)});this.identifyWindow.on("close",this.disableIdentifyTool,this);this.identifyWindowCloseHandler=function(){this.identifyWindow.close()};this.map.proxyOwner.on("click",this.identifyWindowCloseHandler,this);this.identifyWindow.show()},showExportPdfWindow:function(){if(!this.exportPdfWindow){this.exportPdfWindow=this.createExportPdfWindow()}this.exportPdfWindow.show(this)},hideExportPdfWindow:function(){this.exportPdfWindow.hide(this)},createExportPdfWindow:function(){var b=this.map.proxyOwner;var a=[];Ext.each(b.layers,function(c){if(c.visible){a.push(c.url)}});return new Ext.Window({layout:"fit",width:350,closeAction:"hide",autoScroll:true,title:"Export as PDF Settings",modal:true,items:new Ext.FormPanel({id:"export-pdf-settings",border:false,height:100,standardSubmit:true,items:[{xtype:"textfield",emptyText:"Add a title...",fieldLabel:"Title",name:"title"},{xtype:"radiogroup",fieldLabel:"Page Orientation",columns:1,items:[{boxLabel:"Portrait",checked:true,name:"page_layout",inputValue:"portrait"},{boxLabel:"Landscape",name:"page_layout",inputValue:"landscape"}]},{xtype:"hidden",name:"services",value:a.join(",")}]}),buttons:[{text:"Export PDF",handler:function(){var e=Ext.getCmp("export-pdf-settings");var d=b.proxy.extent;var h=[d.xmin,d.ymin,d.xmax,d.ymax].join(",");var c='<form id="dl" action="/export" method="POST">';Ext.iterate(e.getForm().getValues(),function(j,i){if(j==="title"&&i==="Add a title..."){return}c+='<input type="hidden" name="'+j+'" value="'+i+'" />'});c+='<input type="hidden" name="bbox" value="'+h+'" />';c+="</form>";var g=Ext.getDom("downloads").contentDocument;g.open();g.write(c);g.close();var f=Ext.getDom("downloads").contentDocument.getElementById("dl");f.submit()}},{text:"Close",handler:function(){this.exportPdfWindow.hide()},scope:this}]})}});var Application={init:function(){console.log("initializing map application ui");this.fullExtent=new esri.geometry.Extent({xmin:-71.6823103005143,ymin:42.6758057421875,xmax:-59.9489118630143,ymax:50.2234131640625,spatialReference:{wkid:4326}});this.map=new Atlas.esri.Map("map",{layers:[{title:"ESRI World Imagery",cached:true,url:"http://server.arcgisonline.com/ArcGIS/rest/services/ESRI_Imagery_World_2D/MapServer",visible:true,identifiable:false},{title:"Provinces &amp; States",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/provinces_and_states/MapServer",visible:false,identifiable:false},{title:"Level 1 Watersheds",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/watersheds_level_01/MapServer",visible:true,identifiable:true},{title:"Level 2 Watersheds",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/watersheds_level_02/MapServer",visible:false,identifiable:true},{title:"Level 6 Watersheds",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/watersheds_level_06/MapServer",visible:false,identifiable:true},{title:"Major Landowner",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/major_landowners/MapServer",visible:false,identifiable:true},{title:"Crown Land",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/crown_land/MapServer",visible:false,identifiable:false},{title:"Protected Areas",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/protected_areas/MapServer",visible:false,identifiable:true},{title:"Administrative Areas",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/administrative_areas/MapServer",visible:false,identifiable:false},{title:"Lakes &amp; Streams",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/lakes_and_streams/MapServer",visible:true,identifiable:true},{title:"Roads",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/nb_roads/MapServer",visible:true,identifiable:false},{title:"Watershed Boundary Lines",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/watersheds_level_01_boundary_lines/MapServer",visible:true,identifiable:false},{title:"Regulated Waters",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/regulated_waters/MapServer",visible:false,identifiable:true},{title:"Surveyed Lakes",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/surveyed_lakes/MapServer",visible:false,identifiable:true},{title:"Lake Depths",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/lake_depths/MapServer",visible:false,identifiable:false},{title:"Stream Types",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/stream_types/MapServer",visible:false,identifiable:true},{title:"Brook Trout Habitat",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/brook_trout_habitat/MapServer",visible:false,identifiable:true},{title:"Atlantic Salmon Juvenile Habitat",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/atlantic_salmon_juvenile_habitat/MapServer",visible:false,identifiable:true},{title:"Atlantic Salmon Adult Habitat",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/atlantic_salmon_adult_habitat/MapServer",visible:false,identifiable:true},{title:"Environmental Stream Survey",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/environmental_stream_survey/MapServer",visible:false,identifiable:true},{title:"Stocked Waters",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/stocked_waters/MapServer",visible:false,identifiable:true},{title:"Hydrometric Stations",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/hydrometric_stations/MapServer",visible:false,identifiable:false},{title:"Groundwater Monitoring Sites",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/groundwater_monitoring_stations/MapServer",visible:false,identifiable:true},{title:"Water Chemistry Sites",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/water_chemistry_sites/MapServer",visible:false,identifiable:true},{title:"Fish Counting Facilities",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/fish_counting_facilities/MapServer",visible:false,identifiable:true},{title:"Electrofishing Sites",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/electrofishing_sites/MapServer",visible:false,identifiable:true},{title:"Temperature Logger Sites",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/temperature_logger_sites/MapServer",visible:false,identifiable:true},{title:"All Monitoring Sites",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/all_monitoring_sites/MapServer",visible:false,identifiable:true},{title:"Stream Order",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/stream_order/MapServer",visible:false,identifiable:false},{title:"Waterbody IDs",cached:true,url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/water_body_ids/MapServer",visible:false,identifiable:false}],extent:this.fullExtent});Ext.get("disclaimer-btn").on("click",this.showDisclaimerWindow,this);Ext.get("help-btn").on("click",this.showHelpWindow,this);this.header=this.createHeader();this.mapContents=this.createMapContents();this.mapPanel=this.createMapPanel();this.footer=this.createFooter();var a=new Ext.Viewport({layout:"border",items:[this.header,this.mapContents,this.mapPanel,this.footer],listeners:{afterlayout:function(){this.contentsLoadingMask=new Ext.LoadMask(this.mapContents.body);this.contentsLoadingMask.show()},single:true,scope:this}});this.map.on("load",this.mapPanel.initMapFunctionality,this.mapPanel);this.mapContents.on("ready",function(){this.contentsLoadingMask.hide()},this)},showDisclaimerWindow:function(){if(!this.disclaimerWindow){this.disclaimerWindow=this.createDisclaimerWindow()}this.disclaimerWindow.show(this)},hideDisclaimerWindow:function(){this.disclaimerWindow.hide()},createDisclaimerWindow:function(){return new Ext.Window({el:"disclaimer-win",layout:"fit",width:500,height:300,closeAction:"hide",autoScroll:true,modal:true,buttons:[{text:"OK",handler:this.hideDisclaimerWindow,scope:this}]})},showHelpWindow:function(){if(!this.helpWindow){this.helpWindow=this.createHelpWindow()}this.helpWindow.show(this)},hideHelpWindow:function(){this.helpWindow.hide()},createHelpWindow:function(){return new Ext.Window({el:"help-win",layout:"fit",width:500,height:300,autoScroll:true,closeAction:"hide",buttons:[{text:"Close",handler:this.hideHelpWindow,scope:this}]})},createHeader:function(){return new Ext.Panel({region:"north",contentEl:"header",baseCls:"x-plain",margins:"0 0 5 0",autoHeight:true})},createFooter:function(){return new Ext.Panel({region:"south",contentEl:"footer",baseCls:"x-plain",autoHeight:true})},createMapContents:function(){return new Atlas.MapContents({region:"west",collapsible:true,split:true,width:200,margins:"0 0 5 5",map:this.map})},createMapPanel:function(){return new Atlas.MapPanel({region:"center",margins:"0 5 5 0",contentEl:this.map.container})}};Ext.onReady(function(){Ext.QuickTips.init();Ext.apply(Ext.QuickTips.getQuickTip(),{trackMouse:true});dojo.require("esri.map");dojo.require("esri.tasks.identify");dojo.require("esri.toolbars.draw");dojo.require("esri.toolbars.navigation");esri.config.defaults.io.proxyUrl="/arcgisserver/apis/javascript/proxy/proxy.ashx";esri.config.defaults.io.alwaysUseProxy=false;esri.config.defaults.map.zoomDuration=100;esri.config.defaults.map.zoomRate=100;Proj4js.defs["EPSG:2953"]="+proj=sterea +lat_0=46.5 +lon_0=-66.5 +k=0.999912 +x_0=2500000 +y_0=7500000 +ellps=GRS80 +units=m +no_defs";Application.init()});