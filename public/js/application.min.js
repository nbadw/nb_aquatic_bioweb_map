if(typeof(window.console)==="undefined"){window.console={log:function(){}}}String.prototype.capitalize=function(){if(this.length===0){return""}else{return this.substr(0,1).toUpperCase()+this.substr(1)}};String.prototype.titleize=function(){if(this.length===0){return""}else{var c=this.split(" ");for(var b=0,a=c.length;b<a;b++){c[b]=c[b].capitalize()}return c.join(" ")}};Number.prototype.formatHuman=function(){var d=""+this;var e=d.split(".");var c=e[0];var a=e[1]||"";var b=/(\d+)(\d{3})/;while(b.test(c)){c=c.replace(b,"$1,$2")}return a.length===0?c:c+"."+a};Ext.ns("Atlas.esri");Atlas.esri.Map=function(b,a){a=a||{};this.proxy=new esri.Map(b,a);this.proxy.proxyOwner=this;Ext.applyIf(this,this.proxy);this.addEvents("load","layeradd","beforeupdate","update","click");this.registerProxyEvents();this.registerLayerUpdateTriggers();Ext.each(a.layers,function(c){this.addLayer(c)},this)};Ext.extend(Atlas.esri.Map,Ext.util.Observable,{layers:[],loadCount:0,updating:false,addLayer:function(b,a){b=new Atlas.esri.Layer(b);b.on("update",this.onLayerUpdated,this);this.layers.push(b);this.proxy.addLayer(b.proxy,a)},registerProxyEvents:function(){dojo.connect(this.proxy,"onLoad",this,function(a){this.fireEvent("load",a)});dojo.connect(this.proxy,"onLayerAdd",this,function(a){this.fireEvent("layeradd",a)});dojo.connect(this.proxy,"onClick",this,function(a){this.fireEvent("click",a)})},registerLayerUpdateTriggers:function(){Ext.each(["onZoomStart","onPanStart"],function(a){dojo.connect(this.proxy,a,this,function(){this.loadCount=0;this.updating=true;this.fireEvent("beforeupdate")})},this)},onLayerUpdated:function(){this.loadCount++;if(this.loadCount===this.layers.length){this.updating=false;this.fireEvent("update")}}});Ext.ns("Atlas.esri");Atlas.esri.Layer=function(a){this.proxy=this.createLayer(a);this.proxy.proxyOwner=this;Ext.applyIf(this,this.proxy);this.title=a.title;if(a.identifiable){this.identifiable=a.identifiable}this.addEvents("update","legend");dojo.connect(this.proxy,"onUpdate",this,function(){this.fireEvent("update")});dojo.connect(this.proxy,"onLoad",this,function(b){this.fireEvent("load",b.proxyOwner)})};Ext.extend(Atlas.esri.Layer,Ext.util.Observable,{legendLoaded:false,identifiable:false,name:function(){if(!this.title){var a=this.proxy.url.split("/");var b=a[a.length-2].replace("_"," ","g").titleize();this.title=b}return this.title},canIdentify:function(){return(this.identifiable&&this.proxy.visible)},createLayer:function(b){if(b instanceof esri.layers.Layer){return b}else{if(typeof b==="string"){return new esri.layers.ArcGISDynamicMapServiceLayer(b)}else{var a={visible:b.visible,opacity:b.opacity};if(b.cached||b.tiled){return new esri.layers.ArcGISTiledMapServiceLayer(b.url,a)}else{return new esri.layers.ArcGISDynamicMapServiceLayer(b.url,a)}}}},loadLegend:function(){this.requestLegend()},requestLegend:function(){Ext.Ajax.request({url:Context.path+"/legends",params:{url:this.url},success:function(a,b){this.legend=Ext.decode(a.responseText);this.legendLoaded=true;this.fireEvent("legend",this,this.legend)},failure:function(){console.log("load legend failed");console.log(arguments);this.legendLoaded=true;this.fireEvent("legend",this,null)},scope:this})}});Ext.ns("Atlas");Atlas.FindPanel=Ext.extend(Ext.Panel,{cls:"x-find-panel",initComponent:function(){this.layout={type:"vbox",align:"stretch",padding:5};var b=new Ext.data.GroupingStore({url:Context.path+"/places",reader:new Atlas.PlaceReader(),autoDestroy:true,sortInfo:{field:"geoname",direction:"ASC"},groupField:"generic_term"});var c=new Atlas.PlaceNameSearchField({style:"margin-bottom: 5px"});var a=new Ext.grid.GridPanel({flex:1,store:b,columns:[{id:"geoname",header:"Name",width:160,sortable:true,dataIndex:"geoname"},{header:"Province",width:75,dataIndex:"region_name"},{header:"Type",width:75,dataIndex:"generic_term"}],view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "Items" : "Item"]})'}),stripeRows:true,autoExpandColumn:"geoname",listeners:{cellclick:function(h,j,g,i){var f=h.getStore().getAt(j);var d=parseFloat(f.data.londec);var k=parseFloat(f.data.latdec);this.fireEvent("placeclick",f.data,d,k)},celldblclick:function(h,j,g,i){var f=h.getStore().getAt(j);var d=parseFloat(f.data.londec);var k=parseFloat(f.data.latdec);this.fireEvent("placedblclick",f.data,d,k)},scope:this}});a.on("render",function(){a.tip=new Ext.ToolTip({view:a.getView(),target:a.getView().mainBody,delegate:".x-grid3-row",trackMouse:true,renderTo:document.body,listeners:{beforeshow:function(g){var f=a.getView().findRowIndex(g.triggerElement);var d=a.getStore().getAt(f);var e=d.get("geoname");g.body.dom.innerHTML="Click to place a marker for "+e+" on the map, double-click to zoom to its location"}}})});this.resultsPanel=new Ext.Panel({layout:"card",activeItem:0,flex:1,items:[a,new Ext.Panel({bodyCssClass:"no-placename-results-panel",layout:"vbox",layoutConfig:{pack:"center",align:"center"},items:{id:"no-placename-results",html:"No results found for search query.",border:false}})]});this.items=[c,this.resultsPanel];c.on("triggered",function(d){b.load({params:{geoname:d}})});b.on("beforeload",function(d,e){if(!this.loadingMask){this.loadingMask=new Ext.LoadMask(this.resultsPanel.body,{msg:"Searching..."})}this.loadingMask.show()},this);b.on("load",function(e,d,f){this.resultsPanel.getLayout().setActiveItem(0);this.loadingMask.hide()},this);b.on("exception",function(){this.resultsPanel.getLayout().setActiveItem(1);this.loadingMask.hide()},this);Atlas.FindPanel.superclass.initComponent.call(this)}});Atlas.PlaceNameSearchField=Ext.extend(Ext.form.TriggerField,{triggerClass:"x-form-search-trigger",emptyText:"Enter a place name...",allowBlank:false,minLength:3,initComponent:function(){this.addEvents("triggered");Atlas.PlaceNameSearchField.superclass.initComponent.call(this);this.on("specialkey",function(a,b){if(b.getKey()===b.ENTER){this.onTriggerClick()}},this)},onTriggerClick:function(){if(this.validate()){this.fireEvent("triggered",this.getValue())}}});Atlas.PlaceReader=function(){var a={root:"PlaceName",idProperty:"cgndb_key",successProperty:"success",totalProperty:"total",fields:["generic_term","latitude","longitude","generic_code","location","region_name","relevance_at_scale","status_term","latdec","londec","datum","feature_id","coord_acc_m","geoname","concise_term","rs_value","concise_code","nts_map","cgndb_key"]};Atlas.PlaceReader.superclass.constructor.call(this,a,a.fields)};Ext.extend(Atlas.PlaceReader,Ext.data.JsonReader,{read:function(a){var c=a.responseText;var d=Ext.decode(c);if(!d){throw {message:"JsonReader.read: Json object not found"}}var b=d.SearchResults;return this.readRecords(d.SearchResults)}});Ext.ns("Atlas");Atlas.MapPanel=Ext.extend(Ext.Panel,{cls:"x-mappanel",initComponent:function(){this.tbar=[{id:"zoom-in",icon:"./images/zoom-in2.png",tooltip:"Zoom In",enableToggle:true,scale:"medium",toggleGroup:"map-tools",toggleHandler:function(a,b){if(b){this.enableDragZoom()}else{this.disableDragZoom()}},scope:this},{icon:"./images/full-extent2.png",tooltip:"Zoom To Full Extent",scale:"medium",handler:function(){this.zoomToFullExtent()},scope:this},{id:"identify",icon:"./images/query.png",tooltip:"Identify",enableToggle:true,scale:"medium",toggleGroup:"map-tools",toggleHandler:function(a,b){if(b){this.enableIdentifyTool()}else{this.disableIdentifyTool()}},scope:this},{icon:"./images/search.png",tooltip:"Find a place",scale:"medium",handler:this.showFindWindow,scope:this},{id:"measure",icon:"./images/ruler.png",tooltip:"Measure",enableToggle:true,scale:"medium",toggleGroup:"map-tools",toggleHandler:function(a,b){if(b){this.enableMeasurement()}else{this.disableMeasurement()}},scope:this}];this.bbar=[{id:"mapInfo",icon:"./images/world.png",listeners:{mouseout:function(){},mouseover:function(){},scope:this}},{id:"map-status",xtype:"tbtext",text:"Loading..."},"->","-",{id:"coordinates",xtype:"tbtext",text:"X: - Y: -"},"-",{id:"scaleBar",xtype:"tbtext",text:""}];Atlas.MapPanel.superclass.initComponent.call(this)},afterRender:function(){Atlas.MapPanel.superclass.afterRender.call(this);this.zoomIn=Ext.getCmp("zoom-in");this.measure=Ext.getCmp("measure");this.identify=Ext.getCmp("identify");this.coordinates=Ext.getCmp("coordinates");this.scaleBar=Ext.getCmp("scaleBar");this.mapStatus=Ext.getCmp("map-status");this.measurementInfo=Ext.get("measurement-length-info");this.mapInfo=Ext.get("map-info")},initMapFunctionality:function(a){this.map=a;this.map.reposition();this.map.resize();this.map.disableRubberBandZoom();this.map.disableShiftDoubleClickZoom();this.on("resize",function(){if(this.map){this.map.reposition();this.map.resize()}},this);this.draw=new esri.toolbars.Draw(this.map);dojo.connect(this.draw,"onDrawEnd",this,this.handleDraw);this.navigation=new esri.toolbars.Navigation(this.map);dojo.connect(this.navigation,"onExtentHistoryChange",this,this.handleExtentHistoryChange);dojo.connect(this.map,"onExtentChange",this,function(b,e,d,c){if(d||this.scaleBar.getEl().dom.innerHTML===""){this.scaleBar.getEl().dom.innerHTML="Scale: "+Math.round(c.scale).formatHuman()}});dojo.connect(this.map,"onMouseMove",this,function(b){this.coordinates.getEl().dom.innerHTML="X: "+b.mapPoint.x.toPrecision(7)+" Y: "+b.mapPoint.y.toPrecision(7)});dojo.connect(this.map,"onMouseOut",this,function(){this.coordinates.getEl().dom.innerHTML="X: - Y: -"});this.attachUpdateMonitor()},attachUpdateMonitor:function(){var d=this.map.proxyOwner;var a=this.mapStatus.getEl();var f=new Ext.util.TaskRunner();var b={run:function(){var g=/\.{3}$/;var h=a.dom.innerHTML;if(g.test(h)){h=h.replace(g,"")}else{h+="."}a.update(h)},interval:100};var e=function(){a.show();f.start(b)};var c=function(){a.hide();f.stop(b)};if(d.updating){e.call()}else{c.call()}d.on("beforeupdate",e);d.on("update",c)},showFindWindow:function(){if(!this.findWindow){this.findWindow=this.createFindWindow()}this.findWindow.show(this)},createFindWindow:function(){return new Ext.Window({layout:"fit",width:500,height:500,closeAction:"hide",autoScroll:true,title:"Find a Place",items:new Atlas.FindPanel({border:false,listeners:{placeclick:this.onPlaceClick,placedblclick:this.onPlaceDblClick,scope:this}}),buttons:[{text:"Close",handler:function(){this.findWindow.hide();this.map.graphics.clear()},scope:this}]})},onPlaceClick:function(b,a,c){this.highlightPlace(b,a,c)},onPlaceDblClick:function(c,b,e){var a=new esri.geometry.Point(b,e,this.map.spatialReference);var d=new esri.geometry.Extent(b-0.1,e-0.1,b+0.1,e+0.1,this.map.spatialReference);this.map.setExtent(d,true);this.map.centerAt(a);this.highlightPlace(c,b,e)},highlightPlace:function(e,h,g){this.map.graphics.clear();var b=esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE;var i=7;var d=new dojo.Color([255,0,0,0.6]);var a=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,0,0,0.8]),1);var c=new esri.symbol.SimpleMarkerSymbol(b,i,a,d);var f=new esri.geometry.Point(h,g,this.map.spatialReference);this.map.graphics.add(new esri.Graphic(f,c))},enableDragZoom:function(){this.draw.activate(esri.toolbars.Draw.EXTENT)},disableDragZoom:function(){this.draw.deactivate()},calculateMeasurementLength:function(){if(!this.draw._tGraphic||!this.draw._graphic){return -1}var b=0;var a=this.draw._tGraphic.geometry.paths[0];b+=this.calculateDistance(a[0],a[1]);Ext.each(this.draw._graphic.geometry.paths[0],function(c,d,e){var f=this.cachedMeasurements[d];if(f===null){f=this.calculateDistance(e[d-1],c);this.cachedMeasurements[d]=f}b+=f},this);return b},calculateDistance:function(b,a){if(!this.sourceProjection){this.sourceProjection=new Proj4js.Proj("EPSG:"+this.map.spatialReference.wkid)}if(!this.targetProjection||!this.targetSRS){this.targetProjection=new Proj4js.Proj("EPSG:2953");this.targetSRS=new esri.SpatialReference({wkid:2953})}b=new Proj4js.Point(b[0],b[1]);a=new Proj4js.Point(a[0],a[1]);Proj4js.transform(this.sourceProjection,this.targetProjection,b);Proj4js.transform(this.sourceProjection,this.targetProjection,a);return esri.geometry.getLength(new esri.geometry.Point(b.x,b.y,this.targetSRS),new esri.geometry.Point(a.x,a.y,this.targetSRS))},clearMeasurement:function(){this.cachedMeasurements=[0]},updateMeasurement:function(){var a=this.calculateMeasurementLength();if(a!==-1){this.measurementInfo.update("Measurement: "+a+" m")}},enableMeasurement:function(){this.draw.activate(esri.toolbars.Draw.POLYLINE);this.measurementInfo.show();this.measurementInfo.update("Click on the map to begin measuring from that point");var a=dojo.connect(this.map,"onClick",this,function(){dojo.disconnect(a);this.clearMeasurement();this.updateMeasurement();this.draw.movementListener=dojo.connect(this.map,"onMouseMove",this,function(){this.updateMeasurement()})})},disableMeasurement:function(){if(this.draw.movementListener){dojo.disconnect(this.draw.movementListener)}this.draw.deactivate();this.map.graphics.clear();this.measurementInfo.hide()},handleDraw:function(c){if(this.zoomIn.pressed){this.map.setExtent(c,true)}if(this.measure.pressed){var b=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DASH,new dojo.Color([255,0,0]),1);var d=new esri.Graphic(c,b);this.map.graphics.add(d);if(this.draw.movementListener){dojo.disconnect(this.draw.movementListener)}var a=dojo.connect(this.map,"onClick",this,function(){dojo.disconnect(a);this.disableMeasurement();if(this.measure.pressed){this.enableMeasurement()}})}},zoomToFullExtent:function(){var a=Application.fullExtent;if(!a){this.navigation.zoomToFullExtent()}else{this.map.setExtent(a)}},handleExtentHistoryChange:function(){},enableIdentifyTool:function(){var a=this.map.proxyOwner;a.on("click",this.doIdentify,this,{single:true})},disableIdentifyTool:function(){this.identifyWindow.close();this.map.graphics.clear();this.map.proxyOwner.un("click",this.identifyWindowCloseHandler,this);if(this.identify.pressed){this.enableIdentifyTool()}},doIdentify:function(a){var b=new Atlas.IdentifyPanel();b.on("geometryselected",function(d,e){this.map.graphics.clear();var f=new esri.Graphic(e,new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,0,0]),1),new dojo.Color([255,255,0,0.5])));this.map.graphics.add(f)},this);this.identifyWindow=new Ext.Window({layout:"fit",title:"Identify",border:false,bodyStyle:"padding: 0",width:500,height:300,plain:true,items:[b],buttons:[{text:"Close",handler:function(){this.identifyWindow.close()},scope:this}]});var c=this.map;this.identifyWindow.on("show",function(){b.doIdentify(c,a.mapPoint)});this.identifyWindow.on("close",this.disableIdentifyTool,this);this.identifyWindowCloseHandler=function(){this.identifyWindow.close()};this.map.proxyOwner.on("click",this.identifyWindowCloseHandler,this);this.identifyWindow.show()},showExportPdfWindow:function(){if(!this.exportPdfWindow){this.exportPdfWindow=this.createExportPdfWindow()}this.exportPdfWindow.show(this)},hideExportPdfWindow:function(){this.exportPdfWindow.hide(this)},createExportPdfWindow:function(){var b=this.map.proxyOwner;var a=[];Ext.each(b.layers,function(c){if(c.visible){a.push(c.url)}});return new Ext.Window({layout:"fit",width:350,closeAction:"hide",autoScroll:true,title:"Export as PDF Settings",modal:true,items:new Ext.FormPanel({id:"export-pdf-settings",border:false,height:100,standardSubmit:true,items:[{xtype:"textfield",emptyText:"Add a title...",fieldLabel:"Title",name:"title"},{xtype:"radiogroup",fieldLabel:"Page Orientation",columns:1,items:[{boxLabel:"Portrait",checked:true,name:"page_layout",inputValue:"portrait"},{boxLabel:"Landscape",name:"page_layout",inputValue:"landscape"}]},{xtype:"hidden",name:"services",value:a.join(",")}]}),buttons:[{text:"Export PDF",handler:function(){var e=Ext.getCmp("export-pdf-settings");var d=b.proxy.extent;var h=[d.xmin,d.ymin,d.xmax,d.ymax].join(",");var c='<form id="dl" action="/export" method="POST">';Ext.iterate(e.getForm().getValues(),function(j,i){if(j==="title"&&i==="Add a title..."){return}c+='<input type="hidden" name="'+j+'" value="'+i+'" />'});c+='<input type="hidden" name="bbox" value="'+h+'" />';c+="</form>";var g=Ext.getDom("downloads").contentDocument;g.open();g.write(c);g.close();var f=Ext.getDom("downloads").contentDocument.getElementById("dl");f.submit()}},{text:"Close",handler:function(){this.exportPdfWindow.hide()},scope:this}]})}});Ext.ns("Atlas.tree");Atlas.tree.LayerTreeLoader=Ext.extend(Ext.tree.TreeLoader,{url:"/arcserver/soap",getParams:function(a){var b=Atlas.tree.LayerTreeLoader.superclass.getParams.apply(this,arguments);b+="&rest_url="+encodeURIComponent(a.attributes.layer.url);return b},createNode:function(attr){if(this.baseAttrs){Ext.applyIf(attr,this.baseAttrs)}if(this.applyLoader!==false){attr.loader=this}if(typeof attr.uiProvider==="string"){attr.uiProvider=this.uiProviders[attr.uiProvider]||eval(attr.uiProvider)}if(attr.nodeType){return new Ext.tree.TreePanel.nodeTypes[attr.nodeType](attr)}else{return this.createLegendNode(attr)}},createLegendNode:function(a){if(a.legendGroups.length===1){return new Ext.tree.TreeNode({text:a.name,icon:a.legendGroups[0].legendClasses[0].symbolImage.imageURL})}else{}}});Atlas.tree.LayerNode=Ext.extend(Ext.tree.AsyncTreeNode,{loader:new Atlas.tree.LayerTreeLoader()});Ext.ns("Atlas");Atlas.ContentsInfoWindow=Ext.extend(Ext.Window,{layout:"fit",closeAction:"hide",autoScroll:true,title:"Infomation",cache:{},errorTpl:new Ext.XTemplate('<p class="info-error">An error occured while fetching the requested information.</p>'),layerTpl:new Ext.XTemplate('<div class="layer-info">','<p>{[values.description || "No Description Available."]}</p><br/>','<p class="copyright">{values.copyrightText}</p>',"</div>"),layerInfoTpl:new Ext.XTemplate('<div class="layer-info">','<p>{[values.description || "No Description Available."]}</p><br/>','<p class="copyright">{values.copyrightText}</p>',"</div>"),displayInfo:function(a){this.on("show",function(){this.showLoadMask();if(this.cache[a]){this.renderInfo(a)}else{this.requestInfo(a)}},this,{single:true});this.show(a.getUI().getEl())},renderInfo:function(b){var a=b.attributes.layerInfo?this.layerInfoTpl:this.layerTpl;this.applyTemplate(a,this.cache[b])},applyTemplate:function(b,a){b.overwrite(this.body,a);this.hideLoadMask()},requestInfo:function(b){var a=b.attributes.layer.url;if(b.attributes.layerInfo){a+="/"+b.attributes.layerInfo.id}Ext.Ajax.request({url:Context.path+"/info",params:{url:a},success:function(c){this.cache[b]=Ext.decode(c.responseText);this.renderInfo(b)},failure:this.requestFailed,scope:this})},requestFailed:function(){this.applyTemplate(this.errorTpl)},showLoadMask:function(){if(!this.loadMask){this.loadMask=new Ext.LoadMask(this.body)}this.loadMask.show()},hideLoadMask:function(){this.loadMask.hide()}});Ext.ns("Atlas");Atlas.IdentifyPanel=Ext.extend(Ext.Panel,{initComponent:function(){Ext.apply(this,{layout:"card",activeItem:2,flex:1,border:false,items:[this.createMessagePanel("initial-identify-panel","TODO: initial identify message"),this.createMessagePanel("no-identify-results-panel","TODO: no results message"),this.createResultsPanel()]});this.addEvents("geometryselected");Atlas.IdentifyPanel.superclass.initComponent.apply(this,arguments)},activateInitialPanel:function(){this.getLayout().setActiveItem(0)},activateNoResultsPanel:function(){this.getLayout().setActiveItem(1)},activateResultsPanel:function(){this.getLayout().setActiveItem(2)},createMessagePanel:function(c,b){var a=new Ext.Panel({bodyCssClass:c,layout:"vbox",border:false,layoutConfig:{pack:"center",align:"center"},items:{id:c+"-msg",html:b,border:false}});return a},createResultsPanel:function(){var c=new Ext.grid.PropertyGrid({autoScroll:true,border:false,stripeRows:true,source:{},listeners:{beforeedit:function(){return false}}});var b=new Ext.Panel({layout:"card",region:"center",border:false,activeItem:0,items:[this.createMessagePanel("no-result-selected-panel","TODO: no result selected"),c]});this.resultsTree=new Atlas.IdentifyResultsTreePanel({region:"west",width:200,minWidth:150,split:true,listeners:{click:function(f,e){var d=f.attributes.result;if(d){c.setSource(d.feature.attributes);b.getLayout().setActiveItem(1)}else{b.getLayout().setActiveItem(0)}if(d&&d.feature.geometry){this.fireEvent("geometryselected",d,d.feature.geometry)}},scope:this}});var a=new Ext.Panel({layout:"border",items:[this.resultsTree,b]});return a},doIdentify:function(a,c){this.resultsTree.clearResults();var b=a.proxyOwner;Ext.each(b.layers,function(e){if(e.canIdentify()){var d=new esri.tasks.IdentifyTask(e.url);var f=new esri.tasks.IdentifyParameters();var g=e.proxy.layerInfos;f.geometry=c;f.mapExtent=a.extent;f.tolerance=5;f.returnGeometry=true;f.layerOption=esri.tasks.IdentifyParameters.LAYER_OPTION_VISIBLE;f.height=a.height;f.width=a.width;f.dpi=96;this.resultsTree.addIdentifyTask(e,d,f)}},this)}});Atlas.IdentifyResultsTreePanel=Ext.extend(Ext.tree.TreePanel,{autoScroll:true,animate:true,border:false,rootVisible:false,root:{text:"Results"},clearResults:function(){Ext.each(this.root.childNodes,function(a){this.root.removeChild(a)},this)},addIdentifyTask:function(b,a,d){var c=new Atlas.IdentifyTaskNode(b,a,d);this.root.appendChild(c)}});Atlas.IdentifyTaskNode=function(b,a,c){this.loaded=false;this.loading=false;this.layer=b;this.task=a;this.params=c;Atlas.IdentifyTaskNode.superclass.constructor.call(this,{text:b.title});this.addEvents("beforeload","load")};Ext.extend(Atlas.IdentifyTaskNode,Ext.tree.TreeNode,{expand:function(a,d,g,b){if(this.loading){var e;var c=function(){if(!this.loading){clearInterval(e);this.expand(a,d,g,b)}}.createDelegate(this);e=setInterval(c,200);return}if(!this.loaded){if(this.fireEvent("beforeload",this)===false){return}this.loading=true;this.ui.beforeLoad(this);this.startIdentifyTask(a,d,g,b);return}Atlas.IdentifyTaskNode.superclass.expand.call(this,a,d,g,b)},isLoading:function(){return this.loading},loadComplete:function(a,c,d,b){this.loading=false;this.loaded=true;this.ui.afterLoad(this);this.fireEvent("load",this);this.expand(a,c,d,b)},isLoaded:function(){return this.loaded},hasChildNodes:function(){if(!this.isLeaf()&&!this.loaded){return true}else{return Atlas.IdentifyTaskNode.superclass.hasChildNodes.call(this)}},startIdentifyTask:function(b,f,g,e){var d=this;var a=function(h){d.identifyTaskComplete(h);d.loadComplete(b,f,g,e)};var c=function(){d.identifyTaskFailed();d.loadComplete(b,f,g,e)};this.task.execute(this.params,a,c)},identifyTaskFailed:function(){},identifyTaskComplete:function(a){Ext.each(a,function(b){this.addResult(b)},this)},addResult:function(a){var c=this.findOrCreateLayerNode(a);var b=new Ext.tree.TreeNode({text:a.value,result:a});c.appendChild(b)},findOrCreateLayerNode:function(a){var b=this.findChild("layerId",a.layerId);if(!b){b=new Ext.tree.TreeNode({layerId:a.layerId,layerName:a.layerName,count:0,expanded:true});this.appendChild(b)}b.attributes.count=b.attributes.count+1;b.setText(b.attributes.layerName+" ("+b.attributes.count+")");return b}});var Application={init:function(){console.log("initializing map application ui");this.fullExtent=new esri.geometry.Extent({xmin:-69.3504643875024,ymin:42.84622,xmax:-63.4013632447762,ymax:50.55837,spatialReference:{wkid:4326}});this.map=new Atlas.esri.Map("map",{layers:[{url:"http://server.arcgisonline.com/ArcGIS/rest/services/ESRI_Imagery_World_2D/MapServer",cached:true,title:"ESRI World Imagery",visible:false},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/provinces_and_states/MapServer",cached:true,visible:false},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/watersheds_level_01/MapServer",cached:true,identifiable:true},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/watersheds_level_02/MapServer",cached:true,identifiable:true,visible:false},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/watersheds_level_06/MapServer",cached:true,identifiable:true,visible:false},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/major_landowners/MapServer",cached:true,visible:false,identifiable:true},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/crown_land/MapServer",cached:true,visible:false},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/protected_areas/MapServer",cached:true,visible:false,identifiable:true},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/lakes_and_streams/MapServer",cached:true},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/nb_roads/MapServer",cached:true,title:"Roads"},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/watersheds_level_01_boundary_lines/MapServer",cached:true},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/place_names/MapServer",cached:true,visible:false},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/surveyed_lakes/MapServer",cached:true,visible:false,identifiable:true},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/lake_depths/MapServer",cached:true,visible:false},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/stream_types/MapServer",cached:true,visible:false,identifiable:true},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/brook_trout_habitat/MapServer",cached:true,visible:false,identifiable:true},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/atlantic_salmon_juvenile_habitat/MapServer",cached:true,visible:false,identifiable:true},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/atlantic_salmon_adult_habitat/MapServer",cached:true,visible:false,identifiable:true},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/environmental_stream_survey/MapServer",cached:true,visible:false,identifiable:true},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/temperature_logger_sites/MapServer",cached:true,visible:false,identifiable:true},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/stream_order/MapServer",cached:true,visible:false},{url:"http://river.nbwaters.unb.ca/ArcGIS/rest/services/bioweb/water_body_ids/MapServer",cached:true,visible:false}],extent:this.fullExtent});Ext.get("disclaimer-btn").on("click",this.showDisclaimerWindow,this);Ext.get("help-btn").on("click",this.showHelpWindow,this);this.header=this.createHeader();this.mapContents=this.createMapContents();this.mapPanel=this.createMapPanel();var a=new Ext.Viewport({layout:"border",items:[this.header,this.mapContents,this.mapPanel],listeners:{afterlayout:function(){this.contentsLoadingMask=new Ext.LoadMask(this.mapContents.body);this.contentsLoadingMask.show()},single:true,scope:this}});this.map.on("load",this.mapPanel.initMapFunctionality,this.mapPanel);this.mapContents.on("ready",function(){this.contentsLoadingMask.hide()},this)},showDisclaimerWindow:function(){if(!this.disclaimerWindow){this.disclaimerWindow=this.createDisclaimerWindow()}this.disclaimerWindow.show(this)},hideDisclaimerWindow:function(){this.disclaimerWindow.hide()},createDisclaimerWindow:function(){return new Ext.Window({el:"disclaimer-win",layout:"fit",width:500,height:300,closeAction:"hide",autoScroll:true,modal:true,buttons:[{text:"OK",handler:this.hideDisclaimerWindow,scope:this}]})},showHelpWindow:function(){if(!this.helpWindow){this.helpWindow=this.createHelpWindow()}this.helpWindow.show(this)},hideHelpWindow:function(){this.helpWindow.hide()},createHelpWindow:function(){return new Ext.Window({el:"help-win",layout:"fit",width:500,height:300,autoScroll:true,closeAction:"hide",buttons:[{text:"Close",handler:this.hideHelpWindow,scope:this}]})},createHeader:function(){return new Ext.Panel({region:"north",contentEl:"header",baseCls:"x-plain",margins:"0 0 5 0",autoHeight:true})},createMapContents:function(){return new Atlas.MapContents({region:"west",collapsible:true,split:true,width:200,margins:"0 0 5 5",map:this.map})},createMapPanel:function(){return new Atlas.MapPanel({region:"center",margins:"0 5 5 0",contentEl:this.map.container})}};Ext.onReady(function(){Ext.QuickTips.init();dojo.require("esri.map");dojo.require("esri.tasks.identify");dojo.require("esri.toolbars.draw");dojo.require("esri.toolbars.navigation");esriConfig.defaults.io.proxyUrl="/arcgisserver/apis/javascript/proxy/proxy.ashx";esriConfig.defaults.io.alwaysUseProxy=false;esriConfig.defaults.map.zoomDuration=100;esriConfig.defaults.map.zoomRate=100;Proj4js.defs["EPSG:2953"]="+proj=sterea +lat_0=46.5 +lon_0=-66.5 +k=0.999912 +x_0=2500000 +y_0=7500000 +ellps=GRS80 +units=m +no_defs";Application.init()});